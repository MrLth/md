# 1. 首屏渲染

## 最终方案

1. #### 尽可能减少关键文件的数量，以及尽可能压缩其大小以缩短传送时间

2. #### 将任何非必需的 JS 都延迟解析

3. #### 将任何非必需的 CSS 都标记为非关键资源（例如打印和其他媒体查询）

4. #### 将CSS置于`<head>`内，以便浏览器迟早发现并发起请求

5. #### 避免使用 CSS import ，因为它会增加往返次数

>  一个样式表可以使用 CSS import (@import) 指令从另一样式表文件导入规则。不过，应避免使用这些指令，因为它们会在关键路径中增加往返次数：只有在收到并解析完带有 @import 规则的 CSS 样式表之后，才会发现导入的 CSS 资源。

## 1.1 JavaScript的加载、解析、执行会阻塞文档的解析

​	在构建DOM Tree时，HTML解析器若遇到了JavaScript，那么它会暂停文档的解析，将控制权交给JavaScript引擎，等JavaScript引擎执行完毕后，再从中断的地方恢复继续解析文档。

​	也就是说，想要提升首屏渲染速度，就不应该在首屏就加载JavaScript文件

**解决方法：**

1. 将所有 **`<Script>`** 标签都放在 **`<body>`**标签底部
2. 给 **`<script>`**标签添加 **`defer`** 或者 **`async`**属性

> 非异步加载脚本就算放在<body>底部也还是会阻塞DOM的解析的，因为此时<body>和<html>还未闭合，执行完脚本后会再去解析DOM，这样会推迟DOMContentLoaded事件的触发，所以最优解还是使用异步加载
>
> DOMContentLoaded 事件触发得越早，后续的操作就越快被执行，所以 async 相比 defer 会更快

## 1.2 FOUC 样式闪烁

​	由于浏览器渲染机制（例如Firefox），在CSS加载之前，先呈现HTML，就会导致先呈现无样式内容，然后样式突然呈现的现象。

​	这个问题的主要就是CSS文件加载时间过长，或者CSS加载时机过晚

**解决方法：**

1. 将引入外部样式文件的 **`<link>`**标签放在 **`<head>`**中
2. 使用 **webpack** 的 **style-loader** 将外部样式文件打包成内嵌 **`<style>`**标签
3. 使用 **webpack** 的 **optimize-css-assets-webpack-plugin** 或者更新的 **css-minimizer-webpack-plugin** 压缩外部样式文件
4. 外部样式文件过大时可采用分包的机制，浏览器同时支持6个外部文件的请求，并行加载减少加载时长

## 1.3 白屏

​	部分浏览器渲染机制（比如chrome）需要先构建DOM及CSSOM树，构建完成后再进行渲染，如果阻塞了这一过程，就会导致白屏时间过长。

**可能出现原因：**

1. **CSSOM** 构建被阻塞，可能是外部样式文件的加载时机过晚，也可能是外部文件过大导致加载时间过长
2. **DOM** 构建被阻塞，内嵌 **`<script>`**标签会阻塞文档的解析和后续外部文件的加载

**解决方法：** 参考上面两知识点

## 1.4 优化关键渲染路径

​	即优先显示与当前用户操作相关的内容

**词汇：**

1. **关键资源**， 可能阻止网页首次渲染的资源，通常指 **HTML** 和 **CSS** 文件以及 **同步加载脚本**
2. **关键路径长度**，获取所有关键资源所需的往返次数或总时间，比如一个 **HTML** 文件包含一个 **JS** 和 一个 **CSS**文件，那么往返次数就是 **2** 次，因为 JS 和 CSS文件会同时请求
3. **关键字节**，实现网页首次渲染所需的总字节数，它是所有关键资源传送文件大小的总和

**优化：**

1. 对关键路径进行分析和特性描述：资源数、字节数、长度
2. 减少关键资源的数量，包括删除，延迟，以及异步加载
3. 优化关键字节数，压缩关键资源文件
4. 优化其余关键资源的加载顺序，迟早下载所有关键资源，以缩短关键路径长度

**参考**

​	[前端性能优化——关键渲染路径. segmentfault ](https://segmentfault.com/a/1190000013767948)

## 1.5 回流优化

​	回流必定引起重绘，重绘不一定引发回流，回流因为需要重新计算布局，所以成本比重绘高得多，改变子节点很可能会导致父节点的一系列回流

1. 使用 **`transform`** 代替 `top`
2. 不要把节点的属性值放在一个循环里当成循环里变量
3. 不要使用 **`table`**布局，任何改变布局的小改动都会导致整个 **`table`** 的重新布局
4. 将 **`DOM`** 离线后修改，使用 **`document.createFragment`** 先在内存中操作 **`DOM`**
5. 使用 `cssText` 或者 `classList` 集中更改 `DOM` 元素样式
6. **`DOM`** 的属性的读写尽量分离，并且使用变量存储减少读写次数
7. 将 `DOM` 元素使用 **`position:absulte/fixed`**脱离文档流，减少回流影响的范围

## 1.6 IE 各版本和其它浏览器至多可以并行下载的资源数

1. IE6 至多 2 个并发
2. IE7+ 至多 6 个并发
3. Chrome 和 Firefox 至多 6 个并发